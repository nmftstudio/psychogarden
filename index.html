<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Psychogarden | Fractal Bloom Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --void: #030503;
            --glass: rgba(15, 25, 15, 0.7);
            --border: rgba(212, 175, 55, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: var(--void); 
            color: #f0f0f0; 
            font-family: 'Work Sans', sans-serif; 
            overflow: hidden;
            transition: filter 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        canvas { position: absolute; top: 0; left: 0; }
        #lightingCanvas { pointer-events: none; z-index: 4; mix-blend-mode: screen; }

        /* --- UI GLASSMORPHISM --- */
        #ui {
            position: absolute; z-index: 100; width: 100%; height: 100%;
            pointer-events: none; padding: 30px; display: flex; flex-direction: column;
            justify-content: space-between;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 25px;
            pointer-events: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .hud-top { display: flex; justify-content: space-between; }
        .stat-group label { display: block; font-size: 10px; text-transform: uppercase; color: var(--gold); letter-spacing: 2px; }
        .stat-group span { font-family: 'Libre Baskerville', serif; font-size: 24px; font-weight: 700; }

        .nexus-rail {
            position: absolute; right: 30px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; pointer-events: auto;
        }

        .nexus-btn {
            width: 50px; height: 50px; border-radius: 10px;
            background: var(--glass); border: 1px solid var(--border);
            color: var(--gold); cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .nexus-btn:hover { background: var(--gold); color: var(--void); box-shadow: 0 0 20px var(--gold); }

        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-action {
            padding: 12px 30px; border-radius: 40px; border: 1px solid var(--border);
            background: var(--glass); color: #fff; cursor: pointer;
            font-family: 'Work Sans', sans-serif; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1px; transition: 0.3s; pointer-events: auto;
        }
        .btn-action.active { background: var(--gold); color: var(--void); border-color: #fff; }

        /* MODAL */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-box {
            width: 450px; background: var(--void); border: 1px solid var(--gold);
            padding: 40px; text-align: center; border-radius: 4px;
        }

        #loading {
            position: fixed; inset: 0; background: var(--void); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loading"><h2 style="color:var(--gold); letter-spacing: 5px;">INICIALIZANDO NEURAL-NET...</h2></div>

    <canvas id="skyCvs"></canvas>
    <canvas id="mainCvs"></canvas>
    <canvas id="lightingCvs"></canvas>

    <div id="ui">
        <div class="hud-top">
            <div class="glass-panel stat-group">
                <label>Energy Reserve</label>
                <span id="bio-val">1000</span>
            </div>
            <div class="glass-panel stat-group" style="text-align: right;">
                <label>World State</label>
                <span id="world-state">Stable</span>
            </div>
        </div>

        <div class="nexus-rail">
            <button class="nexus-btn" onclick="uiAction('market')">üõí</button>
            <button class="nexus-btn" onclick="uiAction('dna')">üß¨</button>
            <button class="nexus-btn" onclick="uiAction('swarm')">üêù</button>
        </div>

        <div class="controls">
            <button class="btn-action active" id="tool-seed" onclick="setTool('seed')">Plant Seed</button>
            <button class="btn-action" id="tool-harvest" onclick="setTool('harvest')">Extract</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box glass-panel">
            <div id="modal-content"></div>
            <button class="btn-action" style="margin-top:20px; width:100%" onclick="closeModal()">Sync & Return</button>
        </div>
    </div>

    <script>
        /**
         * PSYCHOGARDEN: FRACTAL BLOOM ENGINE
         * High-End Procedural Rendering
         */

        const Engine = {
            state: {
                bio: 1200, plants: [], entities: [],
                time: 0, tool: 'seed', horizon: 0,
                wind: 0, trip: 0
            },
            ctx: {},
            
            init() {
                this.ctx.sky = document.getElementById('skyCvs').getContext('2d');
                this.ctx.main = document.getElementById('mainCvs').getContext('2d');
                this.ctx.light = document.getElementById('lightingCvs').getContext('2d');
                
                window.onresize = () => this.resize();
                this.resize();

                // Interacci√≥n
                document.getElementById('mainCvs').onmousedown = (e) => this.handleClick(e);

                // Start Loop
                requestAnimationFrame((t) => this.loop(t));
                
                // Spawn Inicial
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = 0;
                    setTimeout(() => document.getElementById('loading').remove(), 1000);
                    this.spawnInitial();
                }, 1500);
            },

            resize() {
                this.state.horizon = window.innerHeight * 0.58;
                [document.getElementById('skyCvs'), document.getElementById('mainCvs'), document.getElementById('lightingCvs')].forEach(c => {
                    c.width = window.innerWidth;
                    c.height = window.innerHeight;
                });
            },

            spawnInitial() {
                for(let i=0; i<3; i++) this.state.plants.push(new Plant(Math.random()*window.innerWidth, this.state.horizon));
                setInterval(() => { if(this.state.entities.length < 1) this.state.entities.push(new Observer()); }, 15000);
            },

            handleClick(e) {
                const x = e.clientX; const y = e.clientY;
                if(this.state.tool === 'seed' && y > this.state.horizon - 100) {
                    if(this.state.bio >= 100) {
                        this.state.bio -= 100;
                        this.state.plants.push(new Plant(x, this.state.horizon));
                    }
                } else if(this.state.tool === 'harvest') {
                    this.state.plants = this.state.plants.filter(p => {
                        if(Math.hypot(p.x - x, p.y - y) < 50) { this.state.bio += 250; return false; }
                        return true;
                    });
                }
            },

            loop(t) {
                this.state.time = t * 0.001;
                this.state.wind = Math.sin(this.state.time * 0.5) * 0.02 + Math.sin(this.state.time * 2) * 0.005;

                this.drawSky();
                this.drawWorld();
                this.updateUI();

                requestAnimationFrame((t) => this.loop(t));
            },

            drawSky() {
                const c = this.ctx.sky;
                const g = c.createLinearGradient(0, 0, 0, window.innerHeight);
                g.addColorStop(0, '#050a05');
                g.addColorStop(1, '#020402');
                c.fillStyle = g;
                c.fillRect(0, 0, window.innerWidth, window.innerHeight);
            },

            drawWorld() {
                const ctx = this.ctx.main;
                const ltx = this.ctx.light;
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                ltx.clearRect(0, 0, window.innerWidth, window.innerHeight);

                // Suelo
                ctx.fillStyle = '#050705';
                ctx.fillRect(0, this.state.horizon, window.innerWidth, window.innerHeight);

                // Render Plantas con Bloom
                this.state.plants.forEach(p => {
                    p.update(this.state.wind);
                    p.draw(ctx, ltx);
                });

                // Render Entidades
                this.state.entities = this.state.entities.filter(e => {
                    const active = e.update(this.state.plants);
                    e.draw(ctx);
                    return active;
                });

                // Efecto Global Psicoactivo
                if(this.state.trip > 0.1) {
                    document.body.style.filter = `hue-rotate(${Date.now()*0.05}deg) saturate(2)`;
                    this.state.trip *= 0.995;
                } else {
                    document.body.style.filter = 'none';
                }
            },

            updateUI() {
                document.getElementById('bio-val').innerText = Math.floor(this.state.bio);
                document.getElementById('world-state').innerText = this.state.trip > 0.1 ? 'ALTERED' : 'LUCID';
            }
        };

        // --- CLASE PLANTA: FRACTAL REAL-TIME ---
        class Plant {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.dna = {
                    hue: 100 + Math.random()*150,
                    angle: 0.3 + Math.random()*0.4,
                    complexity: 5 + Math.floor(Math.random()*2),
                    growthSpeed: 0.002 + Math.random()*0.002
                };
                this.growth = 0;
                this.age = 0;
                this.windMod = 0;
                this.isHigh = Math.random() > 0.7; // Bioluminiscente
            }

            update(globalWind) {
                if(this.growth < 1) this.growth += this.dna.growthSpeed;
                this.age += 0.01;
                this.windMod = globalWind;
            }

            draw(ctx, ltx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                this.branch(ctx, ltx, 70 * this.growth, 0, this.dna.complexity);
                ctx.restore();
            }

            branch(ctx, ltx, len, angle, depth) {
                if(depth <= 0) {
                    this.drawFlower(ctx, ltx);
                    return;
                }

                ctx.save();
                // F√çSICA DE VIENTO NOISE: M√°s oscilaci√≥n en las puntas (depth bajo)
                const windEffect = this.windMod * (6 - depth) * 1.5;
                ctx.rotate(angle + windEffect);

                // Estilo de Rama
                ctx.strokeStyle = `hsl(${this.dna.hue}, 30%, ${10 + (6-depth)*8}%)`;
                ctx.lineWidth = depth * 1.5;
                ctx.lineCap = 'round';

                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.lineTo(0, -len);
                ctx.stroke();

                ctx.translate(0, -len);

                // Recursi√≥n Fractal Asim√©trica
                const nextLen = len * 0.75;
                this.branch(ctx, ltx, nextLen, this.dna.angle, depth - 1);
                this.branch(ctx, ltx, nextLen, -this.dna.angle, depth - 1);

                ctx.restore();
            }

            drawFlower(ctx, ltx) {
                const color = `hsl(${this.dna.hue}, 80%, 60%)`;
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(0, 0, 4, 0, Math.PI*2);
                ctx.fill();

                // SISTEMA DE ILUMINACI√ìN (BLOOM)
                if(this.isHigh) {
                    ltx.save();
                    const pos = ctx.getTransform();
                    ltx.translate(pos.e, pos.f);
                    const grad = ltx.createRadialGradient(0,0,0,0,0,20);
                    grad.addColorStop(0, color);
                    grad.addColorStop(1, 'transparent');
                    ltx.fillStyle = grad;
                    ltx.beginPath(); ltx.arc(0,0,20,0,Math.PI*2); ltx.fill();
                    ltx.restore();
                }
            }
        }

        // --- CLASE OBSERVER (IA HUMANOIDE) ---
        class Observer {
            constructor() {
                this.x = -50; this.y = Engine.state.horizon;
                this.speed = 0.7;
                this.isTripping = false;
            }
            update(plants) {
                this.x += this.speed * (this.isTripping ? 0.3 : 1);
                
                // Consumo
                plants.forEach(p => {
                    if(p.growth > 0.9 && Math.abs(this.x - p.x) < 20 && !this.isTripping) {
                        this.isTripping = true;
                        Engine.state.trip = 1;
                        setTimeout(() => { this.isTripping = false; }, 8000);
                    }
                });
                return this.x < window.innerWidth + 100;
            }
            draw(ctx) {
                ctx.fillStyle = this.isTripping ? "#a855f7" : "white";
                if(this.isTripping) ctx.shadowBlur = 15, ctx.shadowColor = "purple";
                ctx.fillRect(this.x - 3, this.y - 35, 6, 25);
                ctx.beginPath(); ctx.arc(this.x, this.y - 40, 5, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // --- UI FUNCTIONS ---
        function setTool(t) {
            Engine.state.tool = t;
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('active'));
            document.getElementById(`tool-${t}`).classList.add('active');
        }

        function uiAction(type) {
            const m = document.getElementById('modal');
            const c = document.getElementById('modal-content');
            m.style.display = 'flex';
            if(type === 'market') {
                c.innerHTML = `<h2>Bio-Exchange</h2><p>Synthesize lifeforms for energy.</p>
                <button class="btn-action" style="margin-top:20px" onclick="Engine.state.bio+=500; closeModal()">+500 Bio Reserve</button>`;
            } else {
                c.innerHTML = `<h2>Nexus Node</h2><p>Stabilizing neural connections...</p>`;
            }
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // Start
        Engine.init();

    </script>
</body>
</html>
