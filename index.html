<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Overgrown - Professional Idle Garden</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2d5016;
            --primary-light: #4a7c2e;
            --accent: #f4a261;
            --accent-bright: #e76f51;
            --bg-dark: #0d1b0a;
            --text-light: #f8f4e8;
            --text-muted: #a8b5a3;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            overflow: hidden;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        /* Character Selection */
        #characterSelection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0d1b0a 0%, #1a3d17 50%, #0d1b0a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
        }

        #characterSelection.hidden { display: none; }

        .char-title {
            font-family: 'Libre Baskerville', serif;
            font-size: clamp(32px, 6vw, 56px);
            margin-bottom: 10px;
            color: var(--accent);
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }

        .char-subtitle {
            font-size: clamp(14px, 2vw, 18px);
            color: var(--text-muted);
            margin-bottom: 40px;
            text-align: center;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            max-width: 1000px;
            width: 100%;
            animation: fadeIn 0.8s ease-out 0.4s both;
        }

        .char-card {
            background: linear-gradient(135deg, rgba(45, 80, 22, 0.3), rgba(26, 61, 23, 0.5));
            border: 3px solid rgba(74, 124, 46, 0.3);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .char-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(244, 162, 97, 0.2), transparent);
            transition: left 0.6s;
        }

        .char-card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: var(--accent);
            box-shadow: 0 20px 50px rgba(244, 162, 97, 0.4);
        }

        .char-card:hover::before { left: 100%; }

        .char-emoji {
            font-size: 80px;
            margin-bottom: 15px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        .char-card:nth-child(2) .char-emoji { animation-delay: 0.5s; }
        .char-card:nth-child(3) .char-emoji { animation-delay: 1s; }
        .char-card:nth-child(4) .char-emoji { animation-delay: 1.5s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .char-name {
            font-family: 'Libre Baskerville', serif;
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .char-bonus {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .char-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Canvases */
        canvas { display: block; }
        #cloudsCanvas, #particlesCanvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        #cloudsCanvas { z-index: 45; }
        #particlesCanvas { z-index: 50; }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(13, 27, 10, 0.95), rgba(26, 61, 23, 0.85));
            padding: 20px;
            border-radius: 16px;
            z-index: 100;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 124, 46, 0.3);
            box-shadow: 0 8px 32px rgba(13, 27, 10, 0.4);
            min-width: 200px;
            transition: all 0.4s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .hud.collapsed {
            padding: 15px;
            min-width: auto;
        }

        .hud.collapsed .hud-content { display: none; }

        .hud-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(244, 162, 97, 0.3);
        }

        .hud.collapsed .hud-header {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .hud-title {
            font-family: 'Libre Baskerville', serif;
            font-size: 18px;
            color: var(--accent);
        }

        .toggle-hud {
            background: rgba(244, 162, 97, 0.2);
            border: 1px solid rgba(244, 162, 97, 0.4);
            color: var(--accent);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .toggle-hud:hover {
            background: var(--accent);
            color: var(--bg-dark);
            transform: rotate(180deg);
        }

        .char-info {
            background: rgba(244, 162, 97, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(244, 162, 97, 0.2);
        }

        .char-avatar {
            font-size: 48px;
            text-align: center;
            margin-bottom: 8px;
        }

        .char-info-name {
            text-align: center;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .char-info-bonus {
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
        }

        .stat {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            transition: all 0.3s;
        }

        .stat:hover { transform: translateX(3px); }

        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 700;
            color: var(--accent);
            font-size: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
            border: 1px solid rgba(74, 124, 46, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #52b788);
            border-radius: 5px;
            transition: width 0.5s;
            box-shadow: 0 0 10px rgba(244, 162, 97, 0.5);
        }

        /* Toolbar */
        .toolbar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(13, 27, 10, 0.95), rgba(26, 61, 23, 0.85));
            padding: 20px;
            border-radius: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 124, 46, 0.3);
            box-shadow: 0 8px 32px rgba(13, 27, 10, 0.4);
        }

        .tool-btn {
            width: 64px;
            height: 64px;
            border: 2px solid rgba(74, 124, 46, 0.3);
            border-radius: 12px;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(45, 80, 22, 0.3), rgba(26, 61, 23, 0.5));
            box-shadow: 0 4px 12px rgba(13, 27, 10, 0.4);
            position: relative;
            overflow: hidden;
        }

        .tool-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.4);
            border-color: var(--accent);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.6);
            transform: scale(1.05);
        }

        /* Weather */
        .weather-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(13, 27, 10, 0.95), rgba(26, 61, 23, 0.85));
            padding: 20px;
            border-radius: 16px;
            z-index: 100;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 124, 46, 0.3);
            box-shadow: 0 8px 32px rgba(13, 27, 10, 0.4);
            text-align: center;
            min-width: 120px;
        }

        .weather-icon {
            font-size: 48px;
            margin-bottom: 10px;
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(13, 27, 10, 0.98), rgba(26, 61, 23, 0.95));
            padding: 40px;
            border-radius: 24px;
            z-index: 200;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(30px);
            border: 2px solid rgba(74, 124, 46, 0.3);
            box-shadow: 0 20px 60px rgba(13, 27, 10, 0.4);
            opacity: 0;
            transition: all 0.3s;
        }

        .modal.show {
            display: block;
            opacity: 1;
        }

        .modal h2 {
            font-family: 'Libre Baskerville', serif;
            margin-bottom: 30px;
            color: var(--accent);
            font-size: 32px;
            border-bottom: 2px solid rgba(244, 162, 97, 0.3);
            padding-bottom: 15px;
        }

        .seed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .seed-card {
            background: linear-gradient(135deg, rgba(45, 80, 22, 0.2), rgba(26, 61, 23, 0.3));
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(74, 124, 46, 0.2);
        }

        .seed-card:hover {
            border-color: var(--accent);
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(244, 162, 97, 0.3);
        }

        .seed-card.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .seed-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .seed-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .seed-price {
            font-size: 13px;
            color: var(--accent);
            font-weight: 700;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(214, 40, 40, 0.3);
            border: 2px solid rgba(214, 40, 40, 0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #d62828;
            transform: rotate(90deg);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, rgba(74, 124, 46, 0.95), rgba(45, 80, 22, 0.9));
            padding: 18px 24px;
            border-radius: 12px;
            z-index: 300;
            animation: slideIn 0.4s;
            max-width: 320px;
            border: 1px solid rgba(244, 162, 97, 0.5);
            box-shadow: 0 8px 32px rgba(13, 27, 10, 0.4);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .coin-popup {
            position: fixed;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            pointer-events: none;
            z-index: 500;
            animation: coinFloat 1s ease-out forwards;
            text-shadow: 0 2px 8px rgba(13, 27, 10, 0.4);
        }

        @keyframes coinFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }

        /* AI Companion */
        .ai-tip {
            position: fixed;
            bottom: 120px;
            right: 20px;
            background: linear-gradient(135deg, rgba(74, 124, 46, 0.95), rgba(45, 80, 22, 0.9));
            padding: 15px 20px;
            border-radius: 15px;
            z-index: 150;
            max-width: 300px;
            border: 2px solid var(--accent);
            box-shadow: 0 8px 32px rgba(13, 27, 10, 0.4);
            animation: slideIn 0.5s ease-out;
        }

        .ai-tip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--accent);
        }

        .ai-tip-text {
            font-size: 13px;
            line-height: 1.4;
        }

        .journal-entry {
            background: linear-gradient(135deg, rgba(45, 80, 22, 0.2), rgba(26, 61, 23, 0.3));
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }

        .journal-entry:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 16px rgba(244, 162, 97, 0.2);
        }

        .rarity-common { border-left-color: #9ca3af; }
        .rarity-uncommon { border-left-color: #52b788; }
        .rarity-rare { border-left-color: #3b82f6; }
        .rarity-epic { border-left-color: #a855f7; }
        .rarity-legendary { border-left-color: #f59e0b; }
        .rarity-mythic { border-left-color: #ef4444; }
    </style>
</head>
<body>
    <!-- Character Selection -->
    <div id="characterSelection">
        <div class="char-title">üåø Elige tu Granjero</div>
        <div class="char-subtitle">Cada personaje tiene habilidades √∫nicas</div>
        <div class="char-grid">
            <div class="char-card" onclick="selectCharacter('botanist')">
                <span class="char-emoji">üå±</span>
                <div class="char-name">Bot√°nico</div>
                <div class="char-bonus">+30% XP por descubrimientos</div>
                <div class="char-desc">Experto en mutaciones. Aprende m√°s r√°pido y descubre especies raras.</div>
            </div>
            <div class="char-card" onclick="selectCharacter('farmer')">
                <span class="char-emoji">üë®‚Äçüåæ</span>
                <div class="char-name">Granjero</div>
                <div class="char-bonus">+25% Monedas al cosechar</div>
                <div class="char-desc">Maestro de la cosecha. Obtiene mejores recompensas de plantas maduras.</div>
            </div>
            <div class="char-card" onclick="selectCharacter('gardener')">
                <span class="char-emoji">üåª</span>
                <div class="char-name">Jardinero</div>
                <div class="char-bonus">+50% Velocidad de crecimiento</div>
                <div class="char-desc">Las plantas crecen m√°s r√°pido bajo su cuidado experto.</div>
            </div>
            <div class="char-card" onclick="selectCharacter('alchemist')">
                <span class="char-emoji">üß™</span>
                <div class="char-name">Alquimista</div>
                <div class="char-bonus">+100% Mutaciones</div>
                <div class="char-desc">Domina las mutaciones. Las plantas mutan con el doble de probabilidad.</div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <canvas id="cloudsCanvas"></canvas>
    <canvas id="particlesCanvas"></canvas>

    <div class="hud">
        <div class="hud-header">
            <div class="hud-title">üìä Stats</div>
            <button class="toggle-hud" onclick="toggleHUD()">‚àí</button>
        </div>
        <div class="hud-content">
            <div class="char-info">
                <div class="char-avatar" id="charAvatar">üå±</div>
                <div class="char-info-name" id="charName">Bot√°nico</div>
                <div class="char-info-bonus" id="charBonus">+30% XP</div>
            </div>
            <div class="stat">
                <span class="stat-label"><span>üí∞</span> Coins</span>
                <span class="stat-value" id="coins">100</span>
            </div>
            <div class="stat">
                <span class="stat-label"><span>üå±</span> Semillas</span>
                <span class="stat-value" id="seedCount">10</span>
            </div>
            <div class="stat">
                <span class="stat-label"><span>üèÜ</span> Nivel</span>
                <span class="stat-value" id="level">1</span>
            </div>
            <div class="stat" style="flex-direction: column; align-items: flex-start; gap: 5px;">
                <span class="stat-label"><span>‚≠ê</span> XP: <span id="xp">0</span> / <span id="xpNeeded">100</span></span>
                <div class="progress-bar" style="width: 100%;">
                    <div class="progress-fill" id="xpBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat">
                <span class="stat-label"><span>üåø</span> Plantas</span>
                <span class="stat-value" id="plantCount">0</span>
            </div>
            <div class="stat">
                <span class="stat-label"><span>ü¶†</span> Salud</span>
                <span class="stat-value" id="gardenHealth">100</span>%
            </div>
        </div>
    </div>

    <div class="weather-indicator">
        <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
        <div style="font-size: 13px; font-weight: 600; margin-bottom: 5px;" id="weatherName">Soleado</div>
        <div style="font-size: 11px; color: var(--text-muted);" id="weatherTime">5:00</div>
    </div>

    <div class="toolbar">
        <button class="tool-btn active" data-tool="seed" onclick="selectTool('seed')">üå±</button>
        <button class="tool-btn" data-tool="cut" onclick="selectTool('cut')">‚úÇÔ∏è</button>
        <button class="tool-btn" data-tool="water" onclick="selectTool('water')">üíß</button>
        <button class="tool-btn" data-tool="fertilizer" onclick="selectTool('fertilizer')">üß™</button>
        <button class="tool-btn" data-tool="harvest" onclick="selectTool('harvest')">üåæ</button>
        <button class="tool-btn" data-tool="shop" onclick="openShop()">üè™</button>
        <button class="tool-btn" data-tool="journal" onclick="openJournal()">üìñ</button>
        <button class="tool-btn" data-tool="deco" onclick="openDeco()">üóø</button>
    </div>

    <div class="modal" id="shopModal">
        <button class="close-btn" onclick="closeModal('shopModal')">√ó</button>
        <h2>üè™ Mercado de Semillas</h2>
        <div class="seed-grid" id="seedShop"></div>
    </div>

    <div class="modal" id="journalModal">
        <button class="close-btn" onclick="closeModal('journalModal')">√ó</button>
        <h2>üìñ Diario Bot√°nico</h2>
        <p style="color: var(--text-muted); margin-bottom: 25px;">
            Especies descubiertas: <span id="speciesCount" style="color: var(--accent); font-weight: 700;">0</span>
        </p>
        <div id="journalEntries"></div>
    </div>

    <div class="modal" id="decoModal">
        <button class="close-btn" onclick="closeModal('decoModal')">√ó</button>
        <h2>üóø Decoraciones del Jard√≠n</h2>
        <div class="seed-grid" id="decoShop"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cloudsCanvas = document.getElementById('cloudsCanvas');
        const cloudsCtx = cloudsCanvas.getContext('2d');
        const particlesCanvas = document.getElementById('particlesCanvas');
        const pctx = particlesCanvas.getContext('2d');

        canvas.width = cloudsCanvas.width = particlesCanvas.width = window.innerWidth;
        canvas.height = cloudsCanvas.height = particlesCanvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = cloudsCanvas.width = particlesCanvas.width = window.innerWidth;
            canvas.height = cloudsCanvas.height = particlesCanvas.height = window.innerHeight;
        });

        // Characters
        const characters = {
            botanist: { emoji: 'üå±', name: 'Bot√°nico', bonus: '+30% XP', xpMult: 1.3, coinMult: 1, growthMult: 1, mutationMult: 1 },
            farmer: { emoji: 'üë®‚Äçüåæ', name: 'Granjero', bonus: '+25% Monedas', xpMult: 1, coinMult: 1.25, growthMult: 1, mutationMult: 1 },
            gardener: { emoji: 'üåª', name: 'Jardinero', bonus: '+50% Crecimiento', xpMult: 1, coinMult: 1, growthMult: 1.5, mutationMult: 1 },
            alchemist: { emoji: 'üß™', name: 'Alquimista', bonus: '+100% Mutaciones', xpMult: 1, coinMult: 1, growthMult: 1, mutationMult: 2 }
        };

        // Game State
        const game = {
            character: null,
            coins: 100,
            seeds: 10,
            level: 1,
            xp: 0,
            plants: [],
            decorations: [],
            weather: 'sunny',
            weatherTimer: 0,
            currentTool: 'seed',
            inventory: { water: 20, fertilizer: 5 },
            discovered: new Set(),
            lastSaveTime: Date.now(),
            insects: [],
            clouds: [],
            aiTips: []
        };

        // Plant types
        const plantTypes = {
            grass: { icon: 'üåø', name: 'Pasto', growTime: 5000, height: 20, value: 2, cutValue: 1, rarity: 'common', mutations: ['clover', 'fern'], xp: 5 },
            clover: { icon: 'üçÄ', name: 'Tr√©bol', growTime: 8000, height: 15, value: 5, cutValue: 3, rarity: 'uncommon', mutations: ['fourLeafClover'], xp: 10 },
            fourLeafClover: { icon: 'üçÄ', name: 'Tr√©bol 4H', growTime: 30000, height: 15, value: 80, cutValue: 50, rarity: 'legendary', mutations: [], xp: 100 },
            fern: { icon: 'üåø', name: 'Helecho', growTime: 12000, height: 35, value: 8, cutValue: 5, rarity: 'uncommon', mutations: ['palmTree'], xp: 15 },
            flower: { icon: 'üå∏', name: 'Flor', growTime: 15000, height: 25, value: 12, cutValue: 8, rarity: 'rare', mutations: ['rose', 'sunflower'], xp: 20 },
            rose: { icon: 'üåπ', name: 'Rosa', growTime: 20000, height: 30, value: 20, cutValue: 15, rarity: 'rare', mutations: ['blueRose'], xp: 30 },
            blueRose: { icon: 'üåπ', name: 'Rosa Azul', growTime: 60000, height: 30, value: 150, cutValue: 100, rarity: 'mythic', mutations: [], xp: 200 },
            sunflower: { icon: 'üåª', name: 'Girasol', growTime: 25000, height: 50, value: 18, cutValue: 12, rarity: 'rare', mutations: ['giantSunflower'], xp: 25 },
            giantSunflower: { icon: 'üåª', name: 'Girasol Gigante', growTime: 50000, height: 80, value: 100, cutValue: 75, rarity: 'epic', mutations: [], xp: 150 },
            mushroom: { icon: 'üçÑ', name: 'Hongo', growTime: 10000, height: 18, value: 10, cutValue: 6, rarity: 'uncommon', mutations: ['magicMushroom'], xp: 12 },
            magicMushroom: { icon: 'üçÑ', name: 'Hongo M√≠stico', growTime: 40000, height: 18, value: 90, cutValue: 60, rarity: 'epic', mutations: [], xp: 120 },
            cactus: { icon: 'üåµ', name: 'Cactus', growTime: 30000, height: 40, value: 30, cutValue: 20, rarity: 'rare', mutations: [], xp: 35 },
            palmTree: { icon: 'üå¥', name: 'Palmera', growTime: 45000, height: 70, value: 45, cutValue: 30, rarity: 'epic', mutations: ['ancientTree'], xp: 50 },
            ancientTree: { icon: 'üå≥', name: '√Årbol Ancestral', growTime: 120000, height: 100, value: 300, cutValue: 200, rarity: 'mythic', mutations: [], xp: 500 },
            bamboo: { icon: 'üéã', name: 'Bamb√∫', growTime: 18000, height: 60, value: 15, cutValue: 10, rarity: 'uncommon', mutations: ['goldenBamboo'], xp: 18 },
            goldenBamboo: { icon: 'üéã', name: 'Bamb√∫ Dorado', growTime: 70000, height: 60, value: 200, cutValue: 150, rarity: 'legendary', mutations: [], xp: 300 }
        };

        const decorations = {
            rock: { icon: 'ü™®', name: 'Roca', price: 20 },
            statue: { icon: 'üóø', name: 'Estatua', price: 100 },
            fountain: { icon: '‚õ≤', name: 'Fuente', price: 250 },
            bench: { icon: 'ü™ë', name: 'Banco', price: 50 },
            lantern: { icon: 'üèÆ', name: 'Linterna', price: 80 },
            shrine: { icon: '‚õ©Ô∏è', name: 'Santuario', price: 500 }
        };

        const weathers = {
            sunny: { icon: '‚òÄÔ∏è', name: 'Soleado', growthMultiplier: 1.0, skyTop: '#87CEEB', skyBottom: '#B0E0E6', cloudOpacity: 0.3, cloudSpeed: 0.5 },
            rainy: { icon: 'üåßÔ∏è', name: 'Lluvioso', growthMultiplier: 1.5, skyTop: '#6B7C93', skyBottom: '#8B95A8', cloudOpacity: 0.8, cloudSpeed: 1.5 },
            cloudy: { icon: '‚òÅÔ∏è', name: 'Nublado', growthMultiplier: 0.8, skyTop: '#A9B8C7', skyBottom: '#C4CFD8', cloudOpacity: 0.9, cloudSpeed: 0.8 },
            storm: { icon: '‚õàÔ∏è', name: 'Tormenta', growthMultiplier: 0.5, skyTop: '#4A5568', skyBottom: '#6B7280', cloudOpacity: 1.0, cloudSpeed: 2.0 },
            rainbow: { icon: 'üåà', name: 'Arco√≠ris', growthMultiplier: 2.0, skyTop: '#87CEEB', skyBottom: '#FFD700', cloudOpacity: 0.4, cloudSpeed: 0.3 }
        };

        // Cloud system
        class Cloud {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * (canvas.height * 0.4);
                this.width = Math.random() * 150 + 100;
                this.height = this.width * 0.6;
                this.baseSpeed = Math.random() * 0.3 + 0.2;
                this.speed = this.baseSpeed;
                this.opacity = 0.6;
            }

            update(weatherMult) {
                this.speed = this.baseSpeed * weatherMult;
                this.x += this.speed;
                if (this.x > canvas.width + this.width) {
                    this.x = -this.width;
                    this.y = Math.random() * (canvas.height * 0.4);
                }
            }

            draw() {
                cloudsCtx.save();
                cloudsCtx.globalAlpha = this.opacity * weathers[game.weather].cloudOpacity;
                cloudsCtx.fillStyle = 'white';
                
                // Draw fluffy cloud shape
                cloudsCtx.beginPath();
                cloudsCtx.arc(this.x, this.y, this.width * 0.3, 0, Math.PI * 2);
                cloudsCtx.arc(this.x + this.width * 0.3, this.y - this.height * 0.2, this.width * 0.35, 0, Math.PI * 2);
                cloudsCtx.arc(this.x + this.width * 0.6, this.y, this.width * 0.3, 0, Math.PI * 2);
                cloudsCtx.arc(this.x + this.width * 0.3, this.y + this.height * 0.1, this.width * 0.25, 0, Math.PI * 2);
                cloudsCtx.fill();
                
                cloudsCtx.restore();
            }
        }

        // Insect system
        class Insect {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * (canvas.height * 0.6);
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.emoji = Math.random() > 0.5 ? 'ü¶ã' : 'üêù';
                this.size = 16;
                this.targetPlant = null;
                this.restTime = 0;
                this.flying = true;
            }

            update(deltaTime) {
                if (this.flying) {
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height * 0.7) this.vy *= -1;
                    
                    if (Math.random() < 0.02) {
                        this.vx = (Math.random() - 0.5) * 2;
                        this.vy = (Math.random() - 0.5) * 2;
                    }
                    
                    if (Math.random() < 0.005 && game.plants.length > 0) {
                        const plant = game.plants[Math.floor(Math.random() * game.plants.length)];
                        if (plant.growth > 50) {
                            this.targetPlant = plant;
                            this.flying = false;
                            this.restTime = 3000 + Math.random() * 2000;
                        }
                    }
                } else {
                    if (this.targetPlant) {
                        this.x = this.targetPlant.x;
                        this.y = this.targetPlant.y - (this.targetPlant.type.height * this.targetPlant.growth / 100);
                    }
                    
                    this.restTime -= deltaTime;
                    if (this.restTime <= 0 || !this.targetPlant) {
                        this.flying = true;
                        this.targetPlant = null;
                        this.vx = (Math.random() - 0.5) * 2;
                        this.vy = (Math.random() - 0.5) * 2;
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (this.flying) {
                    const flutter = Math.sin(Date.now() * 0.01) * 5;
                    ctx.translate(this.x + flutter, this.y);
                } else {
                    ctx.translate(this.x, this.y);
                }
                
                ctx.fillText(this.emoji, 0, 0);
                ctx.restore();
            }
        }

        // Particle system
        class Particle {
            constructor(x, y, emoji) {
                this.x = x;
                this.y = y;
                this.emoji = emoji;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4 - 2;
                this.life = 1;
                this.size = Math.random() * 10 + 15;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.15;
                this.life -= 0.015;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                pctx.save();
                pctx.globalAlpha = this.life;
                pctx.translate(this.x, this.y);
                pctx.rotate(this.rotation);
                pctx.font = `${this.size}px Arial`;
                pctx.textAlign = 'center';
                pctx.textBaseline = 'middle';
                pctx.fillText(this.emoji, 0, 0);
                pctx.restore();
            }
        }

        let particles = [];

        function createParticleBurst(x, y, emoji, count = 8) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, emoji));
            }
        }

        function updateParticles() {
            pctx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
        }

        // Sound system
        const sounds = {};
        function initSounds() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            sounds.plant = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(400, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            };
            
            sounds.cut = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(300, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.15);
                gain.gain.setValueAtTime(0.08, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.15);
            };
            
            sounds.water = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioContext.currentTime);
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1000, audioContext.currentTime);
                gain.gain.setValueAtTime(0.05, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.2);
            };
            
            sounds.harvest = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(500, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.2);
            };
            
            sounds.levelup = () => {
                [0, 0.1, 0.2].forEach((time, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(400 + i * 200, audioContext.currentTime + time);
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime + time);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.3);
                    osc.start(audioContext.currentTime + time);
                    osc.stop(audioContext.currentTime + time + 0.3);
                });
            };
        }

        // Character selection
        function selectCharacter(type) {
            game.character = characters[type];
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('charAvatar').textContent = game.character.emoji;
            document.getElementById('charName').textContent = game.character.name;
            document.getElementById('charBonus').textContent = game.character.bonus;
            showAITip(`¬°Bienvenido! Como ${game.character.name}, ${game.character.bonus.toLowerCase()}. ¬°Empieza plantando semillas!`);
        }

        // AI Tips
        const aiTipsDatabase = [
            "üí° Riega tus plantas para acelerar su crecimiento un 30%",
            "üß™ El fertilizante duplica las probabilidades de mutaci√≥n",
            "ü¶† Las plantas enfermas dan menos recompensas. ¬°C√∫ralas r√°pido!",
            "üåà El clima Arco√≠ris duplica la velocidad de crecimiento",
            "‚úÇÔ∏è Cortar plantas j√≥venes da monedas proporcionales a su crecimiento",
            "üåæ Cosechar plantas maduras puede darte semillas extra",
            "‚≠ê Descubrir nuevas especies da el doble de XP",
            "üè™ Compra semillas raras en el mercado para descubrir especies √©picas"
        ];

        function showAITip(text) {
            const existing = document.querySelector('.ai-tip');
            if (existing) existing.remove();
            
            const tip = document.createElement('div');
            tip.className = 'ai-tip';
            tip.innerHTML = `
                <div class="ai-tip-header">ü§ñ Asistente IA</div>
                <div class="ai-tip-text">${text}</div>
            `;
            document.body.appendChild(tip);
            
            setTimeout(() => {
                tip.style.opacity = '0';
                tip.style.transform = 'translateX(400px)';
                setTimeout(() => tip.remove(), 300);
            }, 6000);
        }

        // Show random tips
        setInterval(() => {
            if (Math.random() < 0.3 && game.character) {
                const tip = aiTipsDatabase[Math.floor(Math.random() * aiTipsDatabase.length)];
                showAITip(tip);
            }
        }, 45000);

        // HUD functions
        function toggleHUD() {
            document.querySelector('.hud').classList.toggle('collapsed');
            const btn = document.querySelector('.toggle-hud');
            btn.textContent = btn.textContent === '‚àí' ? '+' : '‚àí';
        }

        // Plant growth stages
        function getPlantStage(plant) {
            const progress = plant.growth;
            if (progress < 25) return { icon: 'üå±', scale: 0.5 };
            else if (progress < 50) return { icon: 'üåø', scale: 0.7 };
            else if (progress < 75) return { icon: plant.type.icon, scale: 0.85 };
            else return { icon: plant.type.icon, scale: 1.0 };
        }

        function plantSeed(x, y) {
            if (game.seeds <= 0) {
                showNotification('‚ùå ¬°No tienes semillas!');
                return;
            }
            
            const type = plantTypes.grass;
            const plant = {
                x, y, type, growth: 0, plantedAt: Date.now(),
                watered: false, fertilized: false, diseased: false,
                mutationChance: 0.05
            };
            
            game.plants.push(plant);
            game.seeds--;
            discoverPlant('grass');
            createParticleBurst(x, y, 'üå±', 5);
            if (sounds.plant) sounds.plant();
            updateHUD();
        }

        function updatePlants(deltaTime) {
            const weatherMod = weathers[game.weather].growthMultiplier;
            const charMod = game.character ? game.character.growthMult : 1;
            
            game.plants.forEach(plant => {
                if (plant.growth < 100) {
                    let growthRate = (deltaTime / plant.type.growTime) * 100;
                    growthRate *= weatherMod * charMod;
                    if (plant.watered) growthRate *= 1.3;
                    if (plant.fertilized) growthRate *= 1.5;
                    if (plant.diseased) growthRate *= 0.3;
                    plant.growth += growthRate;
                    
                    const mutMult = game.character ? game.character.mutationMult : 1;
                    if (plant.growth > 50 && Math.random() < plant.mutationChance * deltaTime / 1000 * mutMult) {
                        tryMutation(plant);
                    }
                }
                
                if (plant.watered && Math.random() < 0.001 * deltaTime) {
                    plant.watered = false;
                }
            });
        }

        function tryMutation(plant) {
            if (plant.type.mutations && plant.type.mutations.length > 0) {
                const mutation = plant.type.mutations[Math.floor(Math.random() * plant.type.mutations.length)];
                const newType = plantTypes[mutation];
                if (newType) {
                    plant.type = newType;
                    plant.growth = 0;
                    plant.mutationChance = 0.02;
                    discoverPlant(mutation);
                    createParticleBurst(plant.x, plant.y, '‚ú®', 12);
                    showNotification(`‚ú® ¬°Mutaci√≥n! ${newType.name}`);
                }
            }
        }

        function discoverPlant(typeKey) {
            if (!game.discovered.has(typeKey)) {
                game.discovered.add(typeKey);
                const type = plantTypes[typeKey];
                const xpMult = game.character ? game.character.xpMult : 1;
                addXP(type.xp * 2 * xpMult);
                updateJournal();
            }
        }

        function renderPlants() {
            game.plants.forEach(plant => {
                const progress = plant.growth / 100;
                const baseSize = plant.type.height * progress;
                const stage = getPlantStage(plant);
                const size = baseSize * stage.scale;
                
                ctx.save();
                ctx.translate(plant.x, plant.y);
                
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 10;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.ellipse(0, 5, size * 0.4, size * 0.15, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                if (['epic', 'legendary', 'mythic'].includes(plant.type.rarity)) {
                    ctx.shadowColor = '#f4a261';
                    ctx.shadowBlur = 15;
                }
                
                ctx.font = `${size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                
                if (plant.diseased) {
                    ctx.filter = 'hue-rotate(90deg) saturate(0.5) brightness(0.8)';
                }
                
                ctx.fillText(stage.icon, 0, 0);
                ctx.filter = 'none';
                ctx.shadowBlur = 0;
                
                if (progress < 1) {
                    const radius = 10;
                    const angle = Math.PI * 2 * progress;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(0, -size - 15, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.strokeStyle = '#f4a261';
                    ctx.beginPath();
                    ctx.arc(0, -size - 15, radius, -Math.PI / 2, -Math.PI / 2 + angle);
                    ctx.stroke();
                }
                
                let offsetX = -15;
                if (plant.watered) {
                    ctx.font = '14px Arial';
                    ctx.fillText('üíß', offsetX, -size - 25);
                    offsetX += 15;
                }
                if (plant.fertilized) {
                    ctx.font = '14px Arial';
                    ctx.fillText('üß™', offsetX, -size - 25);
                }
                if (plant.diseased) {
                    ctx.font = '16px Arial';
                    ctx.fillText('ü¶†', 0, -size - 40);
                }
                
                ctx.restore();
            });
        }

        function renderDecorations() {
            game.decorations.forEach(deco => {
                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.font = '45px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(deco.icon, deco.x, deco.y);
                ctx.restore();
            });
        }

        function updateWeather(deltaTime) {
            game.weatherTimer += deltaTime;
            if (game.weatherTimer > 60000) {
                const weatherKeys = Object.keys(weathers);
                game.weather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];
                game.weatherTimer = 0;
                const weather = weathers[game.weather];
                document.getElementById('weatherIcon').textContent = weather.icon;
                document.getElementById('weatherName').textContent = weather.name;
                showNotification(`üå§Ô∏è Clima: ${weather.name}`);
            }
            const mins = Math.floor((60000 - game.weatherTimer) / 1000 / 60);
            const secs = Math.floor(((60000 - game.weatherTimer) / 1000) % 60);
            document.getElementById('weatherTime').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
        }

        function updateClouds(deltaTime) {
            const weatherData = weathers[game.weather];
            cloudsCtx.clearRect(0, 0, cloudsCanvas.width, cloudsCanvas.height);
            game.clouds.forEach(cloud => {
                cloud.update(weatherData.cloudSpeed);
                cloud.draw();
            });
        }

        function selectTool(tool) {
            game.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
        }

        function useTool(x, y) {
            switch(game.currentTool) {
                case 'seed': plantSeed(x, y); break;
                case 'cut': cutPlant(x, y); break;
                case 'water': waterPlant(x, y); break;
                case 'fertilizer': fertilizePlant(x, y); break;
                case 'harvest': harvestPlant(x, y); break;
            }
        }

        function cutPlant(x, y) {
            const index = game.plants.findIndex(p => Math.abs(p.x - x) < 30 && Math.abs(p.y - y) < 30);
            if (index !== -1) {
                const plant = game.plants[index];
                const progress = plant.growth / 100;
                let reward = Math.floor(plant.type.cutValue * progress);
                if (plant.diseased) reward = Math.max(1, Math.floor(reward * 0.3));
                
                const coinMult = game.character ? game.character.coinMult : 1;
                reward = Math.floor(reward * coinMult);
                
                game.coins += reward;
                showCoinPopup(plant.x, plant.y, reward);
                createParticleBurst(plant.x, plant.y, plant.type.icon, 10);
                if (sounds.cut) sounds.cut();
                
                const xpMult = game.character ? game.character.xpMult : 1;
                addXP(Math.floor(plant.type.xp * 0.3 * xpMult));
                
                game.plants.splice(index, 1);
                updateHUD();
            }
        }

        function waterPlant(x, y) {
            if (game.inventory.water <= 0) {
                showNotification('‚ùå ¬°Sin agua!');
                return;
            }
            const plant = game.plants.find(p => Math.abs(p.x - x) < 30 && Math.abs(p.y - y) < 30);
            if (plant && !plant.watered) {
                plant.watered = true;
                game.inventory.water--;
                createParticleBurst(plant.x, plant.y, 'üíß', 6);
                if (sounds.water) sounds.water();
                if (plant.diseased && Math.random() < 0.3) {
                    plant.diseased = false;
                    showNotification('üíß ¬°Planta curada!');
                }
                updateHUD();
            }
        }

        function fertilizePlant(x, y) {
            if (game.inventory.fertilizer <= 0) {
                showNotification('‚ùå ¬°Sin fertilizante!');
                return;
            }
            const plant = game.plants.find(p => Math.abs(p.x - x) < 30 && Math.abs(p.y - y) < 30);
            if (plant && !plant.fertilized) {
                plant.fertilized = true;
                plant.mutationChance *= 2;
                game.inventory.fertilizer--;
                createParticleBurst(plant.x, plant.y, 'üß™', 8);
                if (sounds.water) sounds.water();
                if (plant.diseased) {
                    plant.diseased = false;
                    showNotification('üß™ ¬°Planta curada!');
                }
                updateHUD();
            }
        }

        function harvestPlant(x, y) {
            const index = game.plants.findIndex(p => Math.abs(p.x - x) < 30 && Math.abs(p.y - y) < 30 && p.growth >= 100);
            if (index !== -1) {
                const plant = game.plants[index];
                const coinMult = game.character ? game.character.coinMult : 1;
                const reward = Math.floor(plant.type.value * (plant.diseased ? 0.5 : 1) * coinMult);
                
                game.coins += reward;
                
                const xpMult = game.character ? game.character.xpMult : 1;
                addXP(Math.floor(plant.type.xp * xpMult));
                
                showCoinPopup(plant.x, plant.y, reward);
                createParticleBurst(plant.x, plant.y, plant.type.icon, 15);
                if (sounds.harvest) sounds.harvest();
                
                if (Math.random() < 0.3) {
                    game.seeds++;
                    showNotification(`üåæ +${reward}üí∞ +1üå±`);
                } else {
                    showNotification(`üåæ +${reward}üí∞`);
                }
                
                game.plants.splice(index, 1);
                updateHUD();
            }
        }

        function showCoinPopup(x, y, amount) {
            const popup = document.createElement('div');
            popup.className = 'coin-popup';
            popup.textContent = `+${amount}üí∞`;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function addXP(amount) {
            game.xp += amount;
            const needed = game.level * 100;
            if (game.xp >= needed) {
                game.level++;
                game.xp -= needed;
                game.seeds += 5;
                game.coins += 50;
                createParticleBurst(canvas.width / 2, canvas.height / 2, '‚≠ê', 20);
                if (sounds.levelup) sounds.levelup();
                showNotification(`üéâ ¬°NIVEL ${game.level}!\n+5üå± +50üí∞`);
            }
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('coins').textContent = game.coins;
            document.getElementById('seedCount').textContent = game.seeds;
            document.getElementById('level').textContent = game.level;
            document.getElementById('xp').textContent = game.xp;
            document.getElementById('xpNeeded').textContent = game.level * 100;
            document.getElementById('plantCount').textContent = game.plants.length;
            const xpPercent = (game.xp / (game.level * 100)) * 100;
            document.getElementById('xpBar').style.width = xpPercent + '%';
            const healthyPlants = game.plants.filter(p => !p.diseased).length;
            const health = game.plants.length > 0 ? Math.floor((healthyPlants / game.plants.length) * 100) : 100;
            document.getElementById('gardenHealth').textContent = health;
        }

        function openShop() {
            const shop = document.getElementById('seedShop');
            shop.innerHTML = '';
            const items = [
                { name: 'Semillas x5', icon: 'üå±', price: 10, action: () => { game.seeds += 5; game.coins -= 10; } },
                { name: 'Semillas x20', icon: 'üå±', price: 35, action: () => { game.seeds += 20; game.coins -= 35; } },
                { name: 'Agua x10', icon: 'üíß', price: 15, action: () => { game.inventory.water += 10; game.coins -= 15; } },
                { name: 'Fertilizante x3', icon: 'üß™', price: 25, action: () => { game.inventory.fertilizer += 3; game.coins -= 25; } },
                { name: 'Semilla Rara', icon: 'üéÅ', price: 100, action: () => {
                    const rares = Object.entries(plantTypes).filter(([k, v]) => v.rarity === 'rare' || v.rarity === 'epic');
                    if (rares.length > 0) {
                        const [key, type] = rares[Math.floor(Math.random() * rares.length)];
                        game.plants.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, type, growth: 0, plantedAt: Date.now(), watered: false, fertilized: false, diseased: false, mutationChance: 0.05 });
                        discoverPlant(key);
                        game.coins -= 100;
                        showNotification(`‚ú® ${type.name}`);
                    }
                }}
            ];
            
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'seed-card';
                if (game.coins < item.price) card.classList.add('locked');
                card.innerHTML = `
                    <div class="seed-icon">${item.icon}</div>
                    <div class="seed-name">${item.name}</div>
                    <div class="seed-price">${item.price} üí∞</div>
                `;
                card.onclick = () => {
                    if (game.coins >= item.price) {
                        item.action();
                        updateHUD();
                        openShop();
                    }
                };
                shop.appendChild(card);
            });
            document.getElementById('shopModal').classList.add('show');
        }

        function updateJournal() {
            const entries = document.getElementById('journalEntries');
            entries.innerHTML = '';
            document.getElementById('speciesCount').textContent = game.discovered.size;
            
            Object.entries(plantTypes).forEach(([key, type]) => {
                if (game.discovered.has(key)) {
                    const entry = document.createElement('div');
                    entry.className = `journal-entry rarity-${type.rarity}`;
                    entry.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 42px;">${type.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; margin-bottom: 8px; font-size: 18px;">${type.name}</div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px;">
                                    <span style="text-transform: uppercase; font-weight: 600;">${type.rarity}</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    üí∞ ${type.value} | ‚úÇÔ∏è ${type.cutValue} | ‚≠ê ${type.xp}
                                </div>
                            </div>
                        </div>
                    `;
                    entries.appendChild(entry);
                }
            });
        }

        function openJournal() {
            updateJournal();
            document.getElementById('journalModal').classList.add('show');
        }

        function openDeco() {
            const shop = document.getElementById('decoShop');
            shop.innerHTML = '';
            Object.entries(decorations).forEach(([key, deco]) => {
                const card = document.createElement('div');
                card.className = 'seed-card';
                if (game.coins < deco.price) card.classList.add('locked');
                card.innerHTML = `
                    <div class="seed-icon">${deco.icon}</div>
                    <div class="seed-name">${deco.name}</div>
                    <div class="seed-price">${deco.price} üí∞</div>
                `;
                card.onclick = () => {
                    if (game.coins >= deco.price) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        game.decorations.push({ icon: deco.icon, x, y });
                        game.coins -= deco.price;
                        createParticleBurst(x, y, deco.icon, 8);
                        updateHUD();
                        showNotification(`${deco.icon} ¬°${deco.name}!`);
                    }
                };
                shop.appendChild(card);
            });
            document.getElementById('decoModal').classList.add('show');
        }

        function showNotification(text) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.innerHTML = text.replace(/\n/g, '<br>');
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(400px)';
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            useTool(x, y);
        });

        function loadGame() {
            const saved = localStorage.getItem('overgrown-pro');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(game, data);
                game.discovered = new Set(data.discovered);
                if (game.character) {
                    document.getElementById('characterSelection').classList.add('hidden');
                    document.getElementById('charAvatar').textContent = game.character.emoji;
                    document.getElementById('charName').textContent = game.character.name;
                    document.getElementById('charBonus').textContent = game.character.bonus;
                }
            }
            updateHUD();
        }

        function saveGame() {
            game.lastSaveTime = Date.now();
            const saveData = { ...game, discovered: Array.from(game.discovered) };
            localStorage.setItem('overgrown-pro', JSON.stringify(saveData));
        }

        // Game loop
        let lastTime = Date.now();
        function gameLoop() {
            const now = Date.now();
            const deltaTime = now - lastTime;
            lastTime = now;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const currentWeather = weathers[game.weather];
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.6);
            skyGradient.addColorStop(0, currentWeather.skyTop);
            skyGradient.addColorStop(1, currentWeather.skyBottom);
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.6);
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height * 0.6);
            ctx.lineTo(canvas.width, canvas.height * 0.6);
            ctx.stroke();
            
            const groundGradient = ctx.createLinearGradient(0, canvas.height * 0.6, 0, canvas.height);
            groundGradient.addColorStop(0, '#6B5344');
            groundGradient.addColorStop(0.3, '#5C4737');
            groundGradient.addColorStop(1, '#4A3728');
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, canvas.height * 0.6, canvas.width, canvas.height * 0.4);
            
            for (let i = 0; i < 200; i++) {
                const alpha = Math.random() * 0.2;
                const brightness = Math.random() > 0.5 ? 1.2 : 0.8;
                ctx.fillStyle = `rgba(${90 * brightness}, ${70 * brightness}, ${50 * brightness}, ${alpha})`;
                const size = Math.random() * 15 + 5;
                const x = Math.random() * canvas.width;
                const y = canvas.height * 0.6 + Math.random() * canvas.height * 0.4;
                ctx.fillRect(x, y, size, size);
            }
            
            for (let i = 0; i < 80; i++) {
                ctx.fillStyle = `rgba(70, 100, 50, ${Math.random() * 0.4 + 0.1})`;
                const x = Math.random() * canvas.width;
                const y = canvas.height * 0.6 + Math.random() * 20;
                const width = Math.random() * 30 + 10;
                const height = Math.random() * 8 + 3;
                ctx.fillRect(x, y, width, height);
            }
            
            updatePlants(deltaTime);
            updateWeather(deltaTime);
            updateClouds(deltaTime);
            updateParticles();
            
            game.insects.forEach(insect => {
                insect.update(deltaTime);
                insect.draw();
            });
            
            renderDecorations();
            renderPlants();
            
            requestAnimationFrame(gameLoop);
        }

        function initClouds() {
            for (let i = 0; i < 8; i++) {
                game.clouds.push(new Cloud());
            }
        }

        function initInsects() {
            for (let i = 0; i < 5; i++) {
                game.insects.push(new Insect());
            }
        }

        setInterval(saveGame, 30000);

        loadGame();
        initSounds();
        initClouds();
        initInsects();
        gameLoop();
    </script>
</body>
</html>
