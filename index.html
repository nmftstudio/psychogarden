<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üåø Overgrown: Genesis Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(10, 20, 15, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #4ade80; /* Green 400 */
            --accent-dim: #15803d; /* Green 700 */
            --danger: #f87171;
            --gold: #fbbf24;
            --text: #ecfdf5;
            --font-main: 'Outfit', sans-serif;
            --font-code: 'Space Mono', monospace;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background: #050505;
            color: var(--text);
            font-family: var(--font-main);
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYERS --- */
        canvas { position: absolute; top: 0; left: 0; }
        #skyCanvas { z-index: 0; }
        #bgCanvas { z-index: 1; } /* Monta√±as/Nubes */
        #gameCanvas { z-index: 2; } /* Plantas */
        #fxCanvas { z-index: 3; pointer-events: none; } /* Clima/Part√≠culas */
        #uiLayer { position: absolute; z-index: 10; width: 100%; height: 100%; pointer-events: none; }

        /* --- UI COMPONENTS --- */
        .hud-panel {
            pointer-events: auto;
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .resource-group { display: flex; gap: 24px; }
        .stat { display: flex; flex-direction: column; }
        .stat label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.6; margin-bottom: 2px; }
        .stat span { font-family: var(--font-code); font-size: 20px; font-weight: 700; color: var(--accent); }
        .stat.gold span { color: var(--gold); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }

        .weather-widget { text-align: right; }
        .weather-icon { font-size: 24px; margin-bottom: 4px; }
        
        /* Toolbar (Bottom) */
        .toolbar-container {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 12px;
            background: rgba(0,0,0,0.5);
            padding: 8px; border-radius: 24px;
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            pointer-events: auto;
        }

        .tool-btn {
            width: 56px; height: 56px;
            border-radius: 18px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            font-size: 22px;
            cursor: pointer;
            transition: 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        
        .tool-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-4px); }
        .tool-btn.active {
            background: var(--accent); color: #022c22;
            box-shadow: 0 0 20px var(--accent-dim);
            transform: translateY(-8px) scale(1.1);
            z-index: 2;
        }
        
        /* Market Panel (Right) */
        #marketPanel {
            position: absolute; right: 20px; top: 100px; bottom: 120px;
            width: 280px;
            transform: translateX(120%); /* Hidden by default */
            display: flex; flex-direction: column; gap: 10px;
        }
        #marketPanel.open { transform: translateX(0); }

        .market-header { font-size: 14px; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 10px; }
        
        .upgrade-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            padding: 12px; border-radius: 8px;
            cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .upgrade-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); }
        .upgrade-info h4 { margin: 0; font-size: 13px; color: #fff; }
        .upgrade-info p { margin: 4px 0 0; font-size: 11px; color: #aaa; }
        .price-tag { font-family: var(--font-code); font-size: 12px; color: var(--gold); font-weight: bold; }

        /* Toggle Market Button */
        .market-toggle {
            position: absolute; right: 20px; bottom: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--glass); border: 1px solid var(--gold);
            color: var(--gold); font-size: 24px; cursor: pointer;
            pointer-events: auto; z-index: 20;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }

        /* Intro Screen */
        #introScreen {
            position: fixed; z-index: 1000;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1s;
        }
        
        .intro-content { text-align: center; opacity: 0; transform: translateY(20px); animation: fadeUp 1s forwards 0.5s; }
        h1 { font-size: 4rem; margin: 0; background: linear-gradient(to right, #4ade80, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .start-btn {
            margin-top: 40px; padding: 16px 48px;
            background: transparent; border: 1px solid var(--accent);
            color: var(--accent); font-family: var(--font-code);
            font-size: 18px; cursor: pointer; border-radius: 4px;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
        }
        .start-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent-dim); }

        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        /* Toast Notifications */
        .toast-container { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .toast {
            background: rgba(0,0,0,0.8); border-left: 3px solid var(--accent);
            padding: 8px 16px; border-radius: 4px; font-size: 12px;
            animation: slideIn 0.3s forwards, fadeOut 0.5s forwards 2.5s;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; } }

    </style>
</head>
<body>

    <div id="introScreen">
        <div class="intro-content">
            <h1>OVERGROWN</h1>
            <p style="color: #666; letter-spacing: 4px; margin-top: 10px;">PRO GENESIS SYSTEM</p>
            <button class="start-btn" onclick="startGame()">Iniciar Simulaci√≥n</button>
        </div>
    </div>

    <canvas id="skyCanvas"></canvas>
    <canvas id="bgCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <canvas id="fxCanvas"></canvas>

    <div id="uiLayer">
        <div class="top-bar">
            <div class="hud-panel resource-group">
                <div class="stat gold">
                    <label>Biomasa</label>
                    <span id="ui-coins">0</span>
                </div>
                <div class="stat">
                    <label>Semillas</label>
                    <span id="ui-seeds">0</span>
                </div>
                <div class="stat">
                    <label>Nivel Eco</label>
                    <span id="ui-level">1</span>
                </div>
            </div>

            <div class="hud-panel weather-widget">
                <div class="weather-icon" id="ui-weather-icon">‚òÄÔ∏è</div>
                <div class="stat">
                    <label id="ui-weather-text">Despejado</label>
                    <span id="ui-time" style="font-size: 16px;">12:00</span>
                </div>
            </div>
        </div>

        <div class="toast-container" id="toastContainer"></div>

        <div class="toolbar-container">
            <button class="tool-btn active" onclick="Game.setTool('plant')" data-tool="plant" title="Plantar">üå±</button>
            <button class="tool-btn" onclick="Game.setTool('water')" data-tool="water" title="Regar">üíß</button>
            <button class="tool-btn" onclick="Game.setTool('fertilize')" data-tool="fertilize" title="Mutar ADN">üß¨</button>
            <button class="tool-btn" onclick="Game.setTool('harvest')" data-tool="harvest" title="Cosechar">‚ú®</button>
        </div>

        <button class="market-toggle" onclick="Game.toggleMarket()">üõí</button>

        <div id="marketPanel" class="hud-panel">
            <div class="market-header">Laboratorio Gen√©tico</div>
            
            <div class="upgrade-card" onclick="Market.buy('seed_pack')">
                <div class="upgrade-info">
                    <h4>Pack de Semillas</h4>
                    <p>+3 Semillas H√≠bridas</p>
                </div>
                <div class="price-tag">50 Bio</div>
            </div>

            <div class="upgrade-card" onclick="Market.buy('growth_hormone')">
                <div class="upgrade-info">
                    <h4>Hormonas de Crecimiento</h4>
                    <p>Plantas crecen 20% m√°s r√°pido</p>
                </div>
                <div class="price-tag">200 Bio</div>
            </div>

            <div class="upgrade-card" onclick="Market.buy('dna_splice')">
                <div class="upgrade-info">
                    <h4>Empalme Gen√©tico</h4>
                    <p>Valor de venta x1.5</p>
                </div>
                <div class="price-tag">500 Bio</div>
            </div>

             <div class="upgrade-card" onclick="Market.buy('cloud_seeding')">
                <div class="upgrade-info">
                    <h4>Siembra de Nubes</h4>
                    <p>Aumenta probabilidad de lluvia</p>
                </div>
                <div class="price-tag">300 Bio</div>
            </div>
        </div>
    </div>

    <script>
        /* * OVERGROWN PRO: FINAL EDITION
         * Incluye: L-Systems, Mercado, Clima, Ciclo D√≠a/Noche, Audio, Persistencia.
         */

        // --- CONFIGURACI√ìN GLOBAL ---
        const Config = {
            colors: {
                skyDay: '#38bdf8',
                skyNight: '#0f172a',
                sun: '#fcd34d',
                moon: '#e2e8f0',
                rain: 'rgba(148, 163, 184, 0.5)'
            },
            audio: {
                enabled: true,
                volume: 0.1
            }
        };

        // --- SISTEMA DE AUDIO (SINTETIZADOR) ---
        const Sound = {
            ctx: null,
            init: () => {
                Sound.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            play: (type) => {
                if (!Sound.ctx) return;
                const t = Sound.ctx.currentTime;
                const osc = Sound.ctx.createOscillator();
                const gain = Sound.ctx.createGain();
                
                osc.connect(gain);
                gain.connect(Sound.ctx.destination);

                if (type === 'click') {
                    osc.frequency.setValueAtTime(800, t);
                    osc.frequency.exponentialRampToValueAtTime(400, t + 0.1);
                    gain.gain.setValueAtTime(0.05, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if (type === 'coin') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1200, t);
                    osc.frequency.setValueAtTime(1600, t + 0.1);
                    gain.gain.setValueAtTime(0.05, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.3);
                    osc.start(t); osc.stop(t + 0.3);
                } else if (type === 'rain') {
                    // White noise buffer logic omitted for brevity, using simple low freq
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(50, t);
                    gain.gain.setValueAtTime(0.01, t);
                    osc.start(t); osc.stop(t + 0.1);
                }
            }
        };

        // --- CLASES DEL MOTOR ---

        class Plant {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.age = 0;
                this.maxAge = 100 + Math.random() * 50;
                this.dna = {
                    color: `hsl(${Math.random() * 60 + 80}, ${60 + Math.random()*20}%, ${30 + Math.random()*20}%)`,
                    leafColor: `hsl(${Math.random() * 360}, 70%, 60%)`,
                    branchAngle: (Math.PI / (3 + Math.random() * 4)),
                    complexity: 4 + Math.floor(Math.random() * 2), // Niveles de recursi√≥n
                    valueMult: 1
                };
                this.state = 'growing'; // growing, mature, dead
                this.water = 80;
                this.swayOffset = Math.random() * 100;
            }

            update(dt, env) {
                // L√≥gica de crecimiento
                let growthFactor = 0.1 * env.growthMod;
                
                // El clima afecta
                if (env.weather === 'rain') {
                    this.water = Math.min(this.water + 0.5, 100);
                    growthFactor *= 1.5;
                } else if (env.isDay) {
                    this.water -= 0.05;
                } else {
                    growthFactor *= 0.2; // Crece lento de noche
                }

                // Penalizaci√≥n por sequ√≠a
                if (this.water <= 0) {
                    this.water = 0;
                    growthFactor = 0;
                    // Posibilidad de morir si se deja seco mucho tiempo (no implementado para no frustrar)
                }

                if (this.state === 'growing') {
                    this.age += growthFactor;
                    if (this.age >= this.maxAge) {
                        this.state = 'mature';
                        UI.toast("¬°Planta lista para cosechar!");
                    }
                }
            }

            draw(ctx, wind) {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                const scale = Math.min(this.age / 40, 1.5);
                ctx.scale(scale, scale);

                // Indicador de sed
                if (this.water < 20) {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(-5, -10, 10, 2);
                }

                // Dibujar recursivamente
                const sway = Math.sin(Date.now() / 1000 + this.swayOffset) * wind * 0.05;
                this.drawBranch(ctx, 30, 0, this.dna.complexity, sway);

                ctx.restore();
            }

            drawBranch(ctx, len, angle, depth, sway) {
                if (depth === 0) {
                    // Dibujar flor/hoja
                    ctx.beginPath();
                    ctx.fillStyle = this.dna.leafColor;
                    if (this.state === 'mature') {
                        ctx.arc(0, 0, 6, 0, Math.PI * 2); // Fruto/Flor grande
                        // Efecto de brillo
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = this.dna.leafColor;
                    } else {
                        ctx.ellipse(0, 0, 4, 2, angle, 0, Math.PI * 2); // Hoja
                    }
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    return;
                }

                ctx.lineWidth = depth * 1.5;
                ctx.strokeStyle = this.water < 20 ? '#5d4037' : this.dna.color; // Marr√≥n si seco
                ctx.lineCap = 'round';

                ctx.save();
                ctx.rotate(angle + sway);
                
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(0, -len);
                ctx.stroke();

                ctx.translate(0, -len);
                
                // Recursi√≥n
                const newLen = len * 0.75;
                this.drawBranch(ctx, newLen, -this.dna.branchAngle, depth - 1, sway);
                this.drawBranch(ctx, newLen, this.dna.branchAngle, depth - 1, sway);
                
                ctx.restore();
            }
        }

        class Cloud {
            constructor(w) {
                this.x = Math.random() * w;
                this.y = Math.random() * 150 + 20;
                this.speed = Math.random() * 0.2 + 0.1;
                this.size = Math.random() * 40 + 30;
                this.opacity = Math.random() * 0.3 + 0.1;
            }
            update(w) {
                this.x += this.speed;
                if (this.x > w + 100) this.x = -100;
            }
            draw(ctx) {
                ctx.fillStyle = `rgba(255,255,255,${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.arc(this.x + 30, this.y - 10, this.size * 0.8, 0, Math.PI*2);
                ctx.arc(this.x + 50, this.y + 5, this.size * 0.9, 0, Math.PI*2);
                ctx.fill();
            }
        }

        class Particle {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type;
                this.life = 1;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2 - 2; // Upward
                if (type === 'rain') {
                    this.vx = 1; this.vy = 15; this.life = 1;
                }
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.02;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                if (this.type === 'rain') {
                    ctx.strokeStyle = Config.colors.rain;
                    ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - 2, this.y - 10); ctx.stroke();
                } else {
                    ctx.fillStyle = this.type === 'gold' ? Config.colors.sun : '#fff';
                    ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
        }

        // --- GESTOR DEL JUEGO (SINGLETON) ---

        const Game = {
            state: {
                biomass: 150,
                seeds: 3,
                level: 1,
                tool: 'plant',
                weather: 'sunny', // sunny, rain
                rainChance: 0.001,
                time: 8, // 0-24
                growthMod: 1.0,
                sellMod: 1.0
            },
            entities: {
                plants: [],
                particles: [],
                clouds: []
            },
            canvases: {},
            ctx: {},
            dims: { w: 0, h: 0 },

            init: () => {
                // Setup Canvas
                ['sky', 'bg', 'game', 'fx'].forEach(id => {
                    const c = document.getElementById(id + 'Canvas');
                    Game.canvases[id] = c;
                    Game.ctx[id] = c.getContext('2d');
                });
                
                window.addEventListener('resize', Game.resize);
                Game.resize();
                
                // Inputs
                window.addEventListener('mousedown', Game.handleClick);
                
                // Init Entities
                for(let i=0; i<10; i++) Game.entities.clouds.push(new Cloud(Game.dims.w));

                // Load Save
                Game.load();
                
                // Start Loop
                requestAnimationFrame(Game.loop);
                
                // Autosave
                setInterval(Game.save, 10000);
            },

            resize: () => {
                Game.dims.w = window.innerWidth;
                Game.dims.h = window.innerHeight;
                Object.values(Game.canvases).forEach(c => { c.width = Game.dims.w; c.height = Game.dims.h; });
            },

            setTool: (tool) => {
                Game.state.tool = tool;
                Sound.play('click');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            },

            toggleMarket: () => {
                document.getElementById('marketPanel').classList.toggle('open');
                Sound.play('click');
            },

            handleClick: (e) => {
                const rect = Game.canvases.game.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Click en planta?
                const plant = Game.entities.plants.find(p => Math.abs(p.x - x) < 40 && Math.abs(p.y - y) < 80);

                if (Game.state.tool === 'plant') {
                    if (plant) return;
                    if (y < Game.dims.h * 0.5) { UI.toast("El suelo est√° muy lejos..."); return; }
                    if (Game.state.seeds > 0) {
                        Game.state.seeds--;
                        Game.entities.plants.push(new Plant(x, y));
                        UI.spawnParticles(x, y, 'dirt');
                        Sound.play('click');
                    } else {
                        UI.toast("¬°Sin semillas! Compra en el mercado.");
                    }
                } else if (plant) {
                    if (Game.state.tool === 'water') {
                        plant.water = 100;
                        UI.spawnParticles(x, y-40, 'water');
                    } else if (Game.state.tool === 'fertilize') {
                        if (Game.state.biomass >= 10) {
                            Game.state.biomass -= 10;
                            plant.dna.color = `hsl(${Math.random()*360}, 80%, 60%)`;
                            plant.growthRate += 0.5;
                            UI.spawnParticles(x, y-40, 'gold');
                        } else {
                            UI.toast("Necesitas 10 Biomasa para fertilizar");
                        }
                    } else if (Game.state.tool === 'harvest') {
                        if (plant.state === 'mature') {
                            const val = Math.floor(plant.age * 2 * Game.state.sellMod);
                            Game.state.biomass += val;
                            UI.toast(`+${val} Biomasa`);
                            UI.spawnParticles(x, y-50, 'gold', 20);
                            Sound.play('coin');
                            // Eliminar planta
                            Game.entities.plants = Game.entities.plants.filter(p => p !== plant);
                        } else {
                            UI.toast("A√∫n no est√° lista...");
                        }
                    }
                }
                UI.update();
            },

            updateWeather: () => {
                // Ciclo d√≠a/noche r√°pido
                Game.state.time += 0.01;
                if (Game.state.time >= 24) Game.state.time = 0;

                // Probabilidad lluvia
                if (Game.state.weather === 'sunny' && Math.random() < Game.state.rainChance) {
                    Game.state.weather = 'rain';
                    UI.toast("‚òÅÔ∏è Est√° empezando a llover...");
                } else if (Game.state.weather === 'rain' && Math.random() < 0.005) {
                    Game.state.weather = 'sunny';
                    UI.toast("‚òÄÔ∏è El cielo se despeja.");
                }
            },

            loop: () => {
                // Logic
                Game.updateWeather();
                
                const env = { 
                    weather: Game.state.weather, 
                    isDay: Game.state.time > 6 && Game.state.time < 18,
                    growthMod: Game.state.growthMod
                };

                // Clear
                Object.values(Game.ctx).forEach(ctx => ctx.clearRect(0,0, Game.dims.w, Game.dims.h));

                // 1. Sky & Sun/Moon
                const sCtx = Game.ctx.sky;
                const t = Game.state.time;
                let bg = Config.colors.skyDay;
                if (!env.isDay) bg = Config.colors.skyNight;
                
                // Interpolaci√≥n simple de color (podr√≠a mejorarse)
                sCtx.fillStyle = bg;
                sCtx.fillRect(0,0, Game.dims.w, Game.dims.h);

                // Celestial Body
                const cx = Game.dims.w/2 + Math.cos(t/24 * 6.28) * (Game.dims.w/2 - 50);
                const cy = Game.dims.h + Math.sin(t/24 * 6.28) * (Game.dims.h/2);
                sCtx.beginPath();
                sCtx.arc(cx, cy, 60, 0, Math.PI*2);
                sCtx.fillStyle = env.isDay ? Config.colors.sun : Config.colors.moon;
                sCtx.shadowBlur = 50;
                sCtx.shadowColor = sCtx.fillStyle;
                sCtx.fill();
                sCtx.shadowBlur = 0;

                // 2. BG (Clouds & Mountains)
                const bCtx = Game.ctx.bg;
                Game.entities.clouds.forEach(c => { c.update(Game.dims.w); c.draw(bCtx); });
                
                // Mountains
                bCtx.fillStyle = '#111';
                bCtx.beginPath();
                bCtx.moveTo(0, Game.dims.h);
                bCtx.lineTo(0, Game.dims.h - 150);
                for(let i=0; i<=Game.dims.w; i+=50) {
                    bCtx.lineTo(i, Game.dims.h - 150 - Math.random()*20);
                }
                bCtx.lineTo(Game.dims.w, Game.dims.h);
                bCtx.fill();

                // 3. Game (Plants & Ground)
                const gCtx = Game.ctx.game;
                // Ground
                const grad = gCtx.createLinearGradient(0, Game.dims.h-100, 0, Game.dims.h);
                grad.addColorStop(0, '#1c1917');
                grad.addColorStop(1, '#000');
                gCtx.fillStyle = grad;
                gCtx.fillRect(0, Game.dims.h - 100, Game.dims.w, 100);

                // Wind calc
                const wind = Math.sin(Date.now()/1000) + (Game.state.weather === 'rain' ? 2 : 0);
                
                Game.entities.plants.forEach(p => {
                    p.update(0.16, env);
                    p.draw(gCtx, wind);
                });

                // 4. FX (Rain & Particles)
                const fCtx = Game.ctx.fx;
                if (Game.state.weather === 'rain') {
                    for(let i=0; i<5; i++) Game.entities.particles.push(new Particle(Math.random()*Game.dims.w, 0, 'rain'));
                }

                Game.entities.particles.forEach((p, i) => {
                    p.update();
                    p.draw(fCtx);
                    if (p.life <= 0) Game.entities.particles.splice(i, 1);
                });

                // UI Updates
                if (Math.floor(Date.now()/1000) % 2 === 0) UI.update(); // Throttle UI updates

                requestAnimationFrame(Game.loop);
            },

            save: () => {
                const data = {
                    biomass: Game.state.biomass,
                    seeds: Game.state.seeds,
                    level: Game.state.level,
                    upgrades: { growth: Game.state.growthMod, sell: Game.state.sellMod }
                };
                localStorage.setItem('overgrown_save', JSON.stringify(data));
            },

            load: () => {
                const saved = localStorage.getItem('overgrown_save');
                if (saved) {
                    const data = JSON.parse(saved);
                    Game.state.biomass = data.biomass || 0;
                    Game.state.seeds = data.seeds || 3;
                    Game.state.level = data.level || 1;
                    Game.state.growthMod = data.upgrades?.growth || 1;
                    Game.state.sellMod = data.upgrades?.sell || 1;
                    UI.update();
                }
            }
        };

        // --- SISTEMA DE MERCADO ---
        const Market = {
            buy: (item) => {
                const s = Game.state;
                let cost = 0;
                let success = false;

                if (item === 'seed_pack') {
                    cost = 50;
                    if (s.biomass >= cost) { s.biomass -= cost; s.seeds += 3; success = true; }
                } 
                else if (item === 'growth_hormone') {
                    cost = 200;
                    if (s.biomass >= cost) { s.biomass -= cost; s.growthMod += 0.2; success = true; }
                }
                else if (item === 'dna_splice') {
                    cost = 500;
                    if (s.biomass >= cost) { s.biomass -= cost; s.sellMod += 0.5; success = true; }
                }
                else if (item === 'cloud_seeding') {
                    cost = 300;
                    if (s.biomass >= cost) { s.biomass -= cost; s.rainChance += 0.005; Game.state.weather = 'rain'; success = true; }
                }

                if (success) {
                    Sound.play('coin');
                    UI.toast("¬°Compra exitosa!");
                    UI.update();
                    Game.save();
                } else {
                    UI.toast("Insuficiente Biomasa");
                }
            }
        };

        // --- UI HELPERS ---
        const UI = {
            update: () => {
                document.getElementById('ui-coins').innerText = Math.floor(Game.state.biomass);
                document.getElementById('ui-seeds').innerText = Game.state.seeds;
                document.getElementById('ui-level').innerText = Game.state.level;
                
                const timeStr = Math.floor(Game.state.time).toString().padStart(2, '0') + ":00";
                document.getElementById('ui-time').innerText = timeStr;
                
                const wIcon = Game.state.weather === 'sunny' ? '‚òÄÔ∏è' : 'üåßÔ∏è';
                document.getElementById('ui-weather-icon').innerText = wIcon;
                document.getElementById('ui-weather-text').innerText = Game.state.weather === 'sunny' ? "Despejado" : "Lluvia";
            },
            
            toast: (msg) => {
                const con = document.getElementById('toastContainer');
                const el = document.createElement('div');
                el.className = 'toast';
                el.innerText = msg;
                con.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            },

            spawnParticles: (x, y, type, count = 10) => {
                for(let i=0; i<count; i++) {
                    Game.entities.particles.push(new Particle(x, y, type));
                }
            }
        };

        // --- ARRANQUE ---
        function startGame() {
            Sound.init();
            document.getElementById('introScreen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('introScreen').style.display = 'none';
                Game.init();
            }, 1000);
        }

    </script>
</body>
</html>
